<?xml version="1.0"?> 
 <!-- NOTE: to generate java code for any extensions, configure the  -->
 <!-- properties file at $(propertiesFile) accordingly -->
 <!-- DO NOT EDIT THIS FILE -->
<project name="LLRPGenerator" default="compile" basedir=".">
     <property name="src" value="src/main/java"/> 
     <property name="src.test" value="src/test/java"/> 
	 <property name="test_msg_dir" value="src/test/resources"/> 
     <property name="version" value="1.0.0.7-SNAPSHOT"/> 
	 <property name="LTKName" value="ltkjava"/> 
     <property name="res" value="src/main/resources"/> 
     <property name="build" value="target"/>
     <property name="docs" value="docs"/>
     <property name="def" value="../Definitions"/>
     <property name="classpath" value="${build}/classes"/>
     <property name="propertiesFile" value="${res}/generator.properties"/>
     <property name="generated" value="org/llrp/ltk/generated"/>
     <property name="JAXBgenerated" value="org.llrp.ltkGenerator"/>
     <property name="llrpdef_xsd" value="${def}/llrpdef.xsd"/>
     <property name="llrpdef_xml" value="${def}/Core/llrp-1x0-def.xml"/>
     <property name="llrp_xsd" value="${def}/Core/llrp-1x0.xsd"/>
	 
	<taskdef name="xjc" classname="com.sun.tools.xjc.XJCTask">
             <classpath>
	        <fileset dir="lib" includes="*.jar" />
  	     </classpath>
     </taskdef>
	
	
              
     <target name="init"> 
     	  <echo>using ant version '${ant.version}'</echo>
   	<echo>using java version '${java.version}'</echo>
          <mkdir dir="${src}/${generated}/messages"/>
          <mkdir dir="${src}/${generated}/parameters"/>
          <mkdir dir="${src}/${generated}/enumerations"/>
          <mkdir dir="${src}/${generated}/interfaces"/>
          <mkdir dir="${src}/${generated}/custom/messages"/>
          <mkdir dir="${src}/${generated}/custom/parameters"/>
          <mkdir dir="${src}/${generated}/custom/interfaces"/>
          <mkdir dir="${src}/${generated}/custom/enumerations"/>
          <mkdir dir="${build}"/>
     	  <mkdir dir="${build}/test-reports"/>
          <mkdir dir="${build}/classes"/>
          <mkdir dir="${build}/test-classes"/>
          <mkdir dir="${build}/docs/apidoc"/>
     </target>
	
	<target name="jaxb" depends="init">
        <!-- generate the Java content classes from the llrpdef.xsd schema -->
	     <echo message="Compiling the llrpdef.xsd schema with jaxb ..."/>
             <xjc schema="${llrpdef_xsd}" destdir="${src}" package="${JAXBgenerated}.generated">
             	<produces dir="${src}/org/llrp/ltkGenerator/generated" includes="**/*.java" />
             </xjc>	
        </target>   
	
	
	<target name="compileCodeGenerator" depends="jaxb"> 
          <!-- Compile the java code -->
             <echo message="Compiling Code Generator ..."/>
		  <javac srcdir="${src}/org/llrp/ltkGenerator" 
		  		 destdir="${build}/classes" 
		  		 debug="on" 
		  		 target="1.5"
		  		 source="1.5">
	        <classpath>
	        	<pathelement path="${classpath}"/>
	      		<fileset dir="lib">
	        		<include name="**/*.jar"/>
	      		</fileset>
	         </classpath>
		  </javac>
	</target>
	
	
	
	<target name="generate" depends="compileCodeGenerator"> 
	        <!-- run the java code -->
	        <echo message="Generating LTK Java classes from llrpdef.xml and extensions ..."/>
			<java classname="org.llrp.ltkGenerator.CodeGenerator" fork="yes" >
				<arg value="${propertiesFile}"/>
		        <classpath>
		        	<pathelement path="${classpath}"/>
		      		<fileset dir="lib">
		        		<include name="**/*.jar"/>
		      		</fileset>
		         </classpath>
		  	</java>
		</target>
			
		
	<target name="format" depends="generate">  
	        <!-- format the java code -->
	        <echo message="Formatting generated classes ..."/>
			<java classname="org.llrp.ltkGenerator.CodeFormatter" fork="yes" >
				<arg value="${propertiesFile}"/>
		        <classpath>
		        	<pathelement path="${classpath}"/>
		      		<fileset dir="lib">
		        		<include name="**/*.jar"/>
		      		</fileset>
		         </classpath>
		  	</java>
	</target>
	
	 
		<target name="copySchemas">
			<echo message="Copy schemas"/>
			<ant antfile="LoadTask.xml"/>	
		</target>
	
	<target name="compile" depends="format,copySchemas"> 
          <!-- Compile the java code -->
          	<echo message="Compiling LTKJava (generated classes and non-generated classes)..."/>
		  <javac srcdir="${src}" 
		  		 destdir="${build}/classes" 
		  		 debug="on" 
		  		 target="1.5"
		  		 source="1.5"
		  		 excludes="**/testing/**">
	        <classpath>
	        	<pathelement path="${classpath}"/>
	      		<fileset dir="lib">
	        		<include name="**/*.jar"/>
	      		</fileset>
	         </classpath>
		  </javac>
	</target>	
        
    <!-- ===================================== -->
	<!-- Jar Generation -->
	<!-- ===================================== -->
      
        
	<target name="jar" depends="compile"> 
	 <echo message="Creating binary jar without dependencies..."/>
		  <jar destfile="${build}/${LTKName}-${version}.jar">
		  	<fileset dir="${build}/classes"
		  	includes="org/llrp/ltk/**"
            		 excludes="**/testing/"
    		/>
    		<fileset dir="." includes="NOTICE.TXT,README.TXT,LICENSE.txt,CHANGELOG.txt" />
    		<manifest>
			<attribute name="Main-Class" value="org.llrp.ltk.util.LLRPConverter" />
		</manifest>
  		    
		</jar>
	</target>
	
	<target name="jarWithDep" depends="compile">
			<jar destfile="${build}/${LTKName}-${version}-with-dependencies.jar">
				<fileset dir="${build}/classes"
				includes="org/llrp/ltk/**" 
				/>
				<zipfileset src="lib/log4j-1.2.14.jar" />
				<zipfileset src="lib/jdom.jar" />
				<zipfileset src="lib/jargs.jar" />
				<zipfileset src="lib/jaxb-api.jar" />
				<zipfileset src="lib/mina-core-1.1.7.jar" />
				<zipfileset src="lib/slf4j-api-1.5.0.jar" />
				<zipfileset src="lib/xercesImpl.jar" />
				<zipfileset src="lib/slf4j-log4j12-1.5.0.jar" />
				<zipfileset dir="." includes="NOTICE.TXT" prefix="" />
				<zipfileset dir="." includes="README.TXT" prefix="" />
				<zipfileset dir="." includes="LICENSE.txt" prefix="" />
				<zipfileset dir="." includes="CHANGELOG.txt" prefix="" />
				<manifest>
					<attribute name="Main-Class" value="org.llrp.ltk.util.LLRPConverter" />
				</manifest>
			</jar>
	</target>
	
	
	
        <target name="sourceJar" depends="compile"> 
          <echo message="Creating source jar ..."/>
			  <jar destfile="${build}/${LTKName}-${version}-src.jar">
			  	<fileset dir="${src}"
	            		 includes="org/llrp/ltk/**"
	    		/>
	    		<fileset dir="." includes="NOTICE.TXT,README.TXT,LICENSE.txt,CHANGELOG.txt" />
			    
	</jar>
	</target>
	
    <target name="generateJar" depends="generate"> 
	 <echo message="Creating binary jar of generator without dependencies..."/>
		  <jar destfile="${build}/${LTKName}-generator-${version}.jar">
		  	<fileset dir="${build}/classes"
		  	includes="org/llrp/ltkGenerator/**"
            		 excludes="**/testing/"
    		/>
    		<fileset dir="." includes="NOTICE.TXT,README.TXT,LICENSE.txt,CHANGELOG.txt" />
    		<manifest>
		</manifest>
  		    
		</jar>
	</target>
	
	
	<!-- ===================================== -->
	<!-- Javadoc -->
	<!-- ===================================== -->
	
	
	<target name="javadoc" depends="compile"> 
		  <javadoc
	           destdir="${build}/docs/apidoc"
	           author="false"
	           version="false"
	           use="true"
	           windowtitle="LLRP Toolkit for Java">
	
		    <packageset dir="${src}" defaultexcludes="yes">
		      <include name="org/llrp/ltk/**"/>
		      <exclude name="org/llrp/ltkGenerator/**"/>
		    </packageset>
			<classpath>
	        	<pathelement path="${classpath}"/>
	      		<fileset dir="lib">
	        		<include name="**/*.jar"/>
	      		</fileset>
	         </classpath>
		    <doctitle><![CDATA[<h1>LLRP Tool Kit in Java</h1>]]></doctitle>
		    <bottom><![CDATA[<i>Copyright &#169; 2007 ETH Zurich.</i>]]></bottom>
		    <tag name="todo" scope="all" description="To do:"/>
		    <group title="org.llrp" packages="org.llrp*"/>
		    <link href="http://llrp-toolkit.cvs.sourceforge.net/llrp-toolkit/LTK/LTKJava/"/>
	  	</javadoc>
	</target>	
	
	<!-- ===================================== -->
	<!-- package software -->
	<!-- ===================================== -->
	<target name="package" depends="jar,jarWithDep,sourceJar,generateJar">

	</target>
	
	<!-- ===================================== -->
	<!-- deploy daily build -->
	<!-- ===================================== -->
	<target name="deploy" >
		<scp todir="${user}:${pw}@athena.dialup.mit.edu:www/ltk" trust="true">
			 <fileset dir="${build}">
					      <include name="**/*.jar"/>
			 </fileset>
		  </scp>
	</target>
	

	<target name="osgi-bundle" depends="compile">
		<taskdef resource="aQute/bnd/ant/taskdef.properties" 
			             classpath="lib/bnd-0.0.313.jar"/>
		  <bnd classpath="${classpath}" 
		                 eclipse="false" 
		                 failok="false" 
		                 exceptions="true" 
		                 files="ltkjava.bnd"
		                 output="${build}/${LTKName}_${version}.zip"/> 
	</target>
	
	<!-- ===================================== -->
	<!-- Remove build directories -->
	<!-- ===================================== -->
	<target name="clean" >
		<delete dir="${build}" />
		<delete dir="${src}/${generated}" />
		<delete dir="${src}/org/llrp/ltkGenerator/generated" />
	</target>
	
	
	<!-- ===================================== -->
	<!-- Unit testing -->
	<!-- ===================================== -->
	
	<target name="compile-test" depends="compile"> 
	          	<echo message="Compiling LTKJava test cases ..."/>
			  <javac srcdir="${src.test}" 
			  		 destdir="${build}/test-classes" 
			  		 debug="on" 
			  		 target="1.5"
			  		 source="1.5">
		        <classpath>
		        	<pathelement path="${classpath}"/>
		      		<fileset dir="lib">
		        		<include name="**/*.jar"/>
		      		</fileset>
		         </classpath>
			  </javac>
	</target>
	
	
	<target name="unit-test" depends="compile-test">
	    <echo message="Running the unit test cases ..."/>
		<echo message="NOTE: org.llrp.ltk.types.UnsignedLong_DATETIMETest will fail unless you are running the test in the Eastern Standard Time Zone"/>	
		<junit printsummary="yes">
			<test name="org.llrp.ltk.types.SignedIntegerArrayTest"/>
			<test name="org.llrp.ltk.types.SignedShortArrayTest"/>
			<test name="org.llrp.ltk.types.UnsignedByte_HEXTest"/>
			<test name="org.llrp.ltk.types.UnsignedLong_DATETIMETest"/>
			<test name="org.llrp.ltk.types.TwoBitFieldTest"/>
			
			
			  <!--<batchtest fork="no" todir="${build}/test-reports">
			    <fileset dir="${src.test}">
			      <include name="**/*Test*.java"/>
			    </fileset>
			  </batchtest> -->
			<formatter type="plain"/>
			<sysproperty key="propertiesFile" value="${propertiesFile}"/>
			  <classpath>
			    <pathelement location="target/test-classes"/>
			     <pathelement location="target/classes"/>
			  	<fileset dir="lib" includes="*.jar" />
			  </classpath>
		</junit>
	</target>
	
	<target name="xml-test" depends="unit-test">  
		        <!-- format the java code -->
		        <echo message="Running integration test (xml->binary) ..."/>
				<java classname="org.llrp.ltk.util.LLRPConverter" fork="yes" >
					<arg line="-x -d ${test_msg_dir}"/>
			        <classpath>
			        	<pathelement path="${classpath}"/>
			      		<fileset dir="lib">
			        		<include name="**/*.jar"/>
			      		</fileset>
			         </classpath>
			  	</java>
		</target>
	
	<target name="bin-test" depends="unit-test">  
			        <!-- format the java code -->
			        <echo message="Running integration test (binary->xml) ..."/>
					<java classname="org.llrp.ltk.util.LLRPConverter" fork="yes" >
						<arg line="-b -d ${test_msg_dir}"/>
				        <classpath>
				        	<pathelement path="${classpath}"/>
				      		<fileset dir="lib">
				        		<include name="**/*.jar"/>
				      		</fileset>
				         </classpath>
				  	</java>
			</target>
	
	
	<target name="test" depends="unit-test, bin-test, xml-test">  
		</target>
	

	
	
	
	
	<!-- ===================================== -->
	<!-- release zip file -->
	<!-- ===================================== -->
		<target name="release" depends="package,javadoc,bin-test,xml-test">
			    <zip destfile="${build}/LTKJava_${version}.zip">
			    <zipfileset dir="target" includes="LTKJava_with_dep_${version}.jar" prefix="lib" />
			    <zipfileset dir="target" includes="LTKJava_${version}.jar" prefix="lib" />
			    <zipfileset dir="target" includes="LTKJava_src_${version}.jar" prefix="lib" />
				<zipfileset dir="target" includes="LTKJavaGenerator_${version}.jar" prefix="lib" />
			    <zipfileset dir="target/docs" prefix="docs" />	
			    <fileset dir="." includes="NOTICE.TXT"/>	
			    <fileset dir="." includes="LICENSE.txt"/>	
			    <fileset dir="." includes="README.TXT"/>	
			    <fileset dir="." includes="CHANGELOG.txt"/>	
	  		</zip>		
		</target>
	
</project>